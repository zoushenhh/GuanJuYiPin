# 存档格式 V3（模块化分层 / 短路径 / 联机友好）

> 目标：**结构整洁**、职责单一（MECE）、AI 命令 **短路径好记**、支持 **联机权威/同步**、支持旧存档迁移但不把"迁移垃圾"写进新结构。

---

## 1) 顶层只保留 5 个领域（MECE）

- `元数据`（meta）：存档元数据（版本/时间/统计）
- `角色`（avatar）：玩家实体（主角私有数据）
- `社交`（social）：社会交互（关系/宗门/记忆）
- `世界`（world）：世界环境（全局状态/事件/关键 NPC 缓存）
- `系统`（system）：系统层（配置/设置/缓存/联机同步/叙事记录）

> 说明：**联机**下世界是服务器权威；玩家/社交是客户端可写但需同步校验。

---

## 2) 完整结构树（每个节点写清楚）

约定：
- `必填`：读档必须存在；缺失视为坏档或由迁移器补全
- `可选`：可缺省；缺省按默认值处理
- `缓存`：可重建；不参与"权威状态"的判定

```text
存档
├─ 元数据: object (必填)
│  ├─ 版本号: number (=3) (必填)                # 存档结构版本（用于迁移）
│  ├─ 存档ID: string (必填)                    # 唯一ID（uuid/随机串）
│  ├─ 存档名: string (必填)                    # 展示名
│  ├─ 游戏版本: string (可选)                  # 游戏版本（非结构版本）
│  ├─ 创建时间: string (必填, ISO8601)
│  ├─ 更新时间: string (必填, ISO8601)
│  ├─ 游戏时长秒: number (必填)
│  └─ 时间: object (必填)                      # 游戏内时间（用于效果/修炼等计算）
│     ├─ 年: number (必填)
│     ├─ 月: number (必填, 1-12)
│     ├─ 日: number (必填, 1-31)
│     ├─ 小时: number (必填, 0-23)
│     └─ 分钟: number (必填, 0-59)
├─ 角色: object (必填)                         # 主角私有数据（单机=一个，联机=本地玩家）
│  ├─ 身份: object (必填)                      # 身份（静态为主）
│  │  ├─ 名字: string (必填)
│  │  ├─ 性别: string (必填)
│  │  ├─ 种族: string (必填)
│  │  ├─ 世界: string (必填)                   # 例如：朝天大陆
│  │  ├─ 天资: string (必填)                   # 例如：天/地/玄/黄（或项目枚举）
│  │  ├─ 出生: string (必填)                   # 例如：散修出身/世家子弟
│  │  ├─ 出生日期: object (必填)
│  │  │  ├─ 年: number (必填)
│  │  │  ├─ 月: number (必填)
│  │  │  └─ 日: number (必填)
│  │  ├─ 灵根: object (必填)
│  │  │  ├─ 名称: string (必填)                # 五行杂灵根/天灵根等
│  │  │  └─ 品阶: string (必填)                # 下品/中品/上品/极品...
│  │  └─ 天赋: array (可选)                    # 天赋神通/特质（结构由实现决定）
│  │     └─ [i]: object
│  │        ├─ 名称: string (必填)
│  │        ├─ 描述: string (必填)
│  │        └─ 稀有度?: string (可选)
│  │  ├─ 先天六司: object (必填)                # 六司（数值型，身份的一部分）
│  │  │  ├─ 根骨: number (必填)
│  │  │  ├─ 灵性: number (必填)
│  │  │  ├─ 悟性: number (必填)
│  │  │  ├─ 气运: number (必填)
│  │  │  ├─ 魅力: number (必填)
│  │  │  └─ 心性: number (必填)
│  │  └─ 后天六司: object (必填, 缓存)          # 装备/大道/天赋等带来的增量，可重建
│  │     ├─ 根骨: number (必填)
│  │     ├─ 灵性: number (必填)
│  │     ├─ 悟性: number (必填)
│  │     ├─ 气运: number (必填)
│  │     ├─ 魅力: number (必填)
│  │     └─ 心性: number (必填)
│  ├─ 属性: object (必填)                      # 属性数值（动态，可被 AI/系统修改）
│  │  ├─ 境界: object (必填)
│  │  │  ├─ 名称: string (必填)                # 炼气/筑基/金丹...
│  │  │  ├─ 阶段: string (必填)                # 初期/中期/后期/圆满...
│  │  │  ├─ 当前进度: number (必填)            # 当前修炼进度
│  │  │  ├─ 下一级所需: number (必填)          # 突破到下一阶段所需进度
│  │  │  └─ 突破描述: string (必填)            # 突破到下一阶段的描述
│  │  ├─ 气血: object (必填)                   # HP
│  │  │  ├─ 当前: number (必填)
│  │  │  └─ 上限: number (必填)
│  │  ├─ 灵气: object (必填)                   # MP/真元
│  │  │  ├─ 当前: number (必填)
│  │  │  └─ 上限: number (必填)
│  │  ├─ 神识: object (必填)
│  │  │  ├─ 当前: number (必填)
│  │  │  └─ 上限: number (必填)
│  │  ├─ 寿命: object (必填)
│  │  │  ├─ 当前: number (必填)                # 当前剩余寿元
│  │  │  └─ 上限: number (必填)                # 理论寿元上限（可受境界/丹药影响）
│  │  └─ 声望: number (必填)
│  ├─ 位置: object (必填)                      # 位置（玩家当前所处）
│  │  ├─ 描述: string (必填)                   # 对 UI/叙事友好
│  │  ├─ 地图ID: string (可选)                 # 便于联机/地图系统
│  │  ├─ x: number (可选)
│  │  ├─ y: number (可选)
│  │  └─ 灵气浓度: number (可选)               # 1-100，影响修炼速度
│  ├─ 效果: array (必填)                       # 效果（buff/debuff），不再叫"状态效果/修行状态"
│  │  └─ [i]: object
│  │     ├─ 状态名称: string (必填)
│  │     ├─ 类型: string (必填, buff|debuff)
│  │     ├─ 状态描述: string (必填)
│  │     ├─ 来源: string (可选)
│  │     ├─ 生成时间: object (必填)            # 同 元数据.时间 的结构
│  │     └─ 持续时间分钟: number (必填)        # 纯数值，便于计算过期
│  ├─ 身体: object (可选)                      # 身体（伤势/部位/经脉等"身体层"）
│  │  ├─ 总体状况: string (可选)               # 描述性（UI显示）
│  │  └─ 部位: object (可选)                   # 结构由实现决定（例如：左臂/丹田/经脉）
│  ├─ 背包: object (必填)                      # Inventory：唯一物品源
│  │  ├─ 灵石: object (必填)
│  │  │  ├─ 下品: number (必填)
│  │  │  ├─ 中品: number (必填)
│  │  │  ├─ 上品: number (必填)
│  │  │  └─ 极品: number (必填)
│  │  ├─ 货币?: object (可选)                   # 新货币系统（见附录6.2）
│  │  │  └─ <币种ID>: CurrencyAsset
│  │  ├─ 货币设置?: object (可选)               # 货币配置
│  │  │  ├─ 禁用币种: array (string[])
│  │  │  └─ 基准币种?: string
│  │  └─ 物品: object (必填)                   # key=物品ID -> Item（见附录）
│  │     └─ <物品ID>: object
│  ├─ 装备: object (必填)                      # Equipment：只存物品ID引用（引用 角色.背包.物品）
│  │  ├─ 装备1: string|null (必填)
│  │  ├─ 装备2: string|null (必填)
│  │  ├─ 装备3: string|null (必填)
│  │  ├─ 装备4: string|null (必填)
│  │  ├─ 装备5: string|null (必填)
│  │  └─ 装备6: string|null (必填)
│  ├─ 功法: object (必填)                      # 功法掌握与进度（你会哪些功法）——不等于修炼过程
│  │  ├─ 当前功法ID: string|null (必填)        # 当前修炼的功法ID（与修炼.修炼功法.物品ID对应）
│  │  ├─ 功法进度: object (必填)               # key=功法物品ID/功法ID -> progress
│  │  │  └─ <功法ID>: object
│  │  │     ├─ 熟练度: number (必填)           # 0-100
│  │  │     ├─ 已解锁技能: array (必填)        # string[]
│  │  │     └─ 备注?: string (可选)
│  │  └─ 功法套装: object (必填)               # 套装/组合（实现决定）
│  │     ├─ 主修: string|null (必填)
│  │     └─ 辅修: array (必填)                 # string[]
│  ├─ 修炼: object (必填)                      # 修炼过程（你正在怎么修）——状态机
│  │  ├─ 修炼功法: object|null (必填)          # 引用背包里的功法物品（仅引用）
│  │  │  ├─ 物品ID: string (必填)
│  │  │  └─ 名称: string (必填)
│  │  ├─ 修炼状态?: object (可选)
│  │  │  ├─ 模式: string (必填)                # 打坐/闭关/实战/自修/未修炼...
│  │  │  ├─ 开始时间?: string (可选)            # ISO8601时间字符串
│  │  │  └─ 消耗?: object (可选)               # key=资源名 -> number
│  │  ├─ 经脉?: object (可选)
│  │  │  ├─ 图谱ID?: string (可选)
│  │  │  ├─ 已贯通节点?: array (可选)          # string[]
│  │  │  └─ 瓶颈?: array (可选)                # string[]
│  │  ├─ 丹田?: object (可选)
│  │  │  ├─ 品阶?: string (可选)
│  │  │  ├─ 容量?: number (可选)
│  │  │  └─ 当前?: number (可选)
│  │  └─ 突破?: object (可选)
│  │     ├─ 目标境界?: string (可选)
│  │     ├─ 失败次数?: number (可选)
│  │     └─ 需求?: array (可选)                # string[]
│  ├─ 大道: object (必填)                      # 三千大道（数据+进度合并）
│  │  └─ 大道列表: object (必填)
│  │     └─ <大道名>: object
│  │        ├─ 道名: string (必填)
│  │        ├─ 描述: string (必填)
│  │        ├─ 阶段列表: array (必填)
│  │        │  └─ [i]: object { 名称, 描述, 突破经验 }
│  │        ├─ 是否解锁: boolean (必填)
│  │        ├─ 当前阶段: number (必填)
│  │        ├─ 当前经验: number (必填)
│  │        └─ 总经验: number (必填)
│  └─ 技能: object (必填)                      # 掌握技能 + 冷却 + （可选）装备栏
│     ├─ 掌握技能: array (必填)                # MasteredSkill[]（见附录）
│     ├─ 装备栏?: array (可选)                 # string[]（技能ID/名称）
│     └─ 冷却: object (必填)                   # key=技能ID/名称 -> 冷却秒/回合（实现决定）
├─ 社交: object (必填)
│  ├─ 关系: object (必填)                      # NPC档案/关系网络（key=NPC ID/名字）
│  ├─ 关系矩阵?: object (可选)                 # NPC-NPC 关系网（可选，可重建）
│  ├─ 宗门: object (可选)                      # 宗门系统（独立模块，结构由实现决定）
│  ├─ 事件: object (必填)                      # 世界事件系统（v4.0新增）
│  │  ├─ 配置: object (必填)
│  │  │  ├─ 启用随机事件: boolean (必填)
│  │  │  ├─ 最小间隔年: number (必填)
│  │  │  ├─ 最大间隔年: number (必填)
│  │  │  └─ 事件提示词: string (可选)
│  │  ├─ 下次事件时间: object (可选)           # GameTime
│  │  └─ 事件记录: array (必填)                # GameEvent[]
│  │     └─ [i]: object
│  │        ├─ 事件ID: string (必填)
│  │        ├─ 事件名称: string (必填)
│  │        ├─ 事件类型: string (必填)         # 天灾/人祸/人物风波/势力变动/秘境开启/宝物出世
│  │        ├─ 事件描述: string (必填)
│  │        ├─ 影响等级: string (必填)
│  │        ├─ 影响范围: string (必填)
│  │        ├─ 相关人物: array (可选)          # string[]
│  │        ├─ 发生时间: object (必填)         # GameTime
│  │        └─ 事件来源: string (可选)         # 随机/剧情/玩家触发
│  └─ 记忆: object (必填)                      # 记忆（主观/信息摘要）
│     ├─ 短期记忆?: array (可选)
│     ├─ 中期记忆: array (必填)
│     ├─ 长期记忆: array (必填)
│     └─ 隐式中期记忆?: array (可选)
├─ 世界: object (必填)                         # 世界全局（联机：服务器权威）
│  ├─ 信息: object (必填)                      # WorldInfo（世界生成+地图+势力+地点）
│  │  └─ 经济?: object (可选)                  # 经济系统（见附录6.8）
│  └─ 状态: object (可选)                      # 动态世界状态（可选/可重建）
│     ├─ 环境?: object (可选)                  # 灵气浓度/天气/劫数...
│     ├─ 事件?: array (可选)                   # 世界事件（实现决定）
│     ├─ 历史?: array (可选)                   # 世界大事记（客观）
│     └─ NPC状态?: object (可选)               # 关键NPC状态缓存
└─ 系统: object (必填)
   ├─ 配置?: object (可选)                     # SystemConfig（规则/限制/nsfw 等）
   ├─ 设置?: object (可选)                     # 纯前端偏好（UI开关/主题/流式开关等）
   ├─ 缓存?: object (可选, 缓存)               # 可重建的派生数据
   │  ├─ 掌握技能?: array (可选)               # MasteredSkill[]
   │  └─ 临时统计?: object (可选)
   ├─ 行动队列?: object (可选)                 # ActionQueue（可选）
   ├─ 历史?: object (可选)                     # 叙事记录（UI日志）
   │  └─ 叙事?: array (可选)                   # GameMessage[]（见附录）
   ├─ 扩展?: object (可选)                     # Mod/DLC/扩展数据
   └─ 联机: object (必填)                      # 联机信息（联机：服务器/客户端同步）
      ├─ 模式: string (必填, 单机|联机)
      ├─ 房间ID: string|null (可选)
      ├─ 玩家ID: string|null (可选)            # 联机玩家标识
      ├─ 服务器版本: number (可选)             # 服务端权威版本号/递增序列
      ├─ 最后同步时间: string|null (可选, ISO8601)
      ├─ 只读路径: array (必填)                # string[]：联机下禁止客户端改的路径（UI置灰）
      ├─ 世界曝光?: boolean (可选)             # 是否允许他人读取世界关键情报（按服务器策略）
      └─ 冲突策略: string (可选)               # 服务器|客户端|合并（默认服务器）
```

---

## 3) 关键原则（避免基础错误）

### 3.1 "属性 / 效果 / 修炼"必须严格分离（不再三层同义）

- `角色.属性`：**数值属性**（血/气/神识/寿命/声望/境界）
- `角色.效果`：**附着效果**（buff/debuff 列表）
- `角色.修炼`：**修炼过程**（当前功法/模式/闭关/突破等）
- `角色.功法`：**功法掌握与进度**（你会哪些功法、各自熟练度）

### 3.2 "装备"只是一组引用，不再重复存物品

- `角色.背包.物品` 是唯一物品数据源
- `角色.背包.货币` 是统一货币入口（新；可选，兼容旧存档的 `角色.背包.灵石`）
- `角色.装备` 只存"槽位 → 物品ID/null"引用

---

## 4) 参考 JSON（可直接作为"最小可运行模板"）

```json
{
  "元数据": {
    "版本号": 3,
    "存档ID": "save_xxx",
    "存档名": "自动存档-001",
    "游戏版本": "0.0.0",
    "创建时间": "2026-01-04T12:00:00Z",
    "更新时间": "2026-01-04T12:10:00Z",
    "游戏时长秒": 0,
    "时间": { "年": 1000, "月": 1, "日": 1, "小时": 8, "分钟": 0 }
  },
  "角色": {
    "身份": {
      "名字": "韩立",
      "性别": "男",
      "种族": "人族",
      "世界": "朝天大陆",
      "天资": "黄",
      "出生": "散修",
      "出生日期": { "年": 982, "月": 1, "日": 1 },
      "灵根": { "名称": "五行杂灵根", "品阶": "下品" },
      "天赋": []
    },
      "先天六司": { "根骨": 5, "灵性": 5, "悟性": 5, "气运": 5, "魅力": 5, "心性": 5 },
      "后天六司": { "根骨": 0, "灵性": 0, "悟性": 0, "气运": 0, "魅力": 0, "心性": 0 }
    },
    "属性": {
      "境界": { "名称": "练气", "阶段": "初期", "当前进度": 0, "下一级所需": 100, "突破描述": "尚未凝练气海" },
      "气血": { "当前": 100, "上限": 100 },
      "灵气": { "当前": 50, "上限": 50 },
      "神识": { "当前": 10, "上限": 10 },
      "寿命": { "当前": 18, "上限": 80 },
      "声望": 0
    },
    "位置": { "描述": "朝天大陆·无名之地", "地图ID": "w_0", "灵气浓度": 30 },
    "效果": [],
    "身体": { "总体状况": "", "部位": {} },
    "背包": {
      "灵石": { "下品": 0, "中品": 0, "上品": 0, "极品": 0 },
      "货币设置": { "禁用币种": [], "基准币种": "灵石_下品" },
      "货币": {
        "灵石_下品": { "币种": "灵石_下品", "名称": "下品灵石", "数量": 0, "价值度": 1, "描述": "修士通用货币（基准单位）", "图标": "Gem" },
        "铜币": { "币种": "铜币", "名称": "铜币", "数量": 0, "价值度": 0.00001, "描述": "凡俗常用小额货币", "图标": "Coins" }
      },
      "物品": {}
    },
    "装备": { "装备1": null, "装备2": null, "装备3": null, "装备4": null, "装备5": null, "装备6": null },
    "功法": { "当前功法ID": null, "功法进度": {}, "功法套装": { "主修": null, "辅修": [] } },
    "修炼": { "修炼功法": null, "修炼状态": { "模式": "未修炼" } },
    "大道": { "大道列表": {} },
    "技能": { "掌握技能": [], "装备栏": [], "冷却": {} }
  },
  "社交": {
    "关系": {},
    "宗门": null,
    "事件": {
      "配置": { "启用随机事件": true, "最小间隔年": 1, "最大间隔年": 10, "事件提示词": "" },
      "下次事件时间": null,
      "事件记录": []
    },
    "记忆": { "短期记忆": [], "中期记忆": [], "长期记忆": [], "隐式中期记忆": [] }
  },
  "世界": {
    "信息": {
      "世界名称": "朝天大陆",
      "大陆信息": [],
      "势力信息": [],
      "地点信息": [],
      "生成时间": "2026-01-04T12:00:00Z",
      "世界背景": "",
      "世界纪元": "",
      "特殊设定": [],
      "版本": "v1"
    },
    "状态": { "环境": {}, "事件": [], "历史": [], "NPC状态": {} }
  },
  "系统": {
    "配置": {},
    "设置": {},
    "缓存": { "掌握技能": [], "临时统计": {} },
    "行动队列": { "actions": [] },
    "历史": { "叙事": [] },
    "扩展": {},
    "联机": { "模式": "单机", "房间ID": null, "玩家ID": null, "只读路径": ["世界"], "世界曝光": false, "冲突策略": "服务器" }
  }
}
```

---

## 5) 给 AI 的"短路径"（固定且好记）

> 分步生成优化：**第 1 步只写正文**，不要发送任何结构定义/命令规则；**第 2 步**才发送命令规则并输出结构化命令。

- 境界：`角色.属性.境界.名称` / `角色.属性.境界.当前进度`
- 血/气：`角色.属性.气血.当前` / `角色.属性.灵气.当前`
- 位置：`角色.位置.描述` / `角色.位置.x` / `角色.位置.灵气浓度`
- 效果：`角色.效果[]`
- 修炼：`角色.修炼.修炼状态.模式` / `角色.修炼.修炼功法.物品ID`
- 功法：`角色.功法.当前功法ID` / `角色.功法.功法进度.{功法ID}.熟练度`
- 背包：`角色.背包.物品` / `角色.装备.装备1`

---

## 5.1) AI数据发送规范（统一精简版）

> **重要变更**：无论单步还是分步模式，AI都只接收精简版存档，以减少token消耗。

### 精简版存档结构（所有模式通用）

```text
存档（精简版 - 所有模式统一使用）
├─ 元数据
│  ├─ 时间: ✅ 发送                              # 用于时间判定和叙事时间戳
│  ├─ 版本号: ❌ 不发送                          # 纯技术字段，不影响叙事
│  ├─ 存档ID: ❌ 不发送                          # 纯技术字段，不影响叙事
│  ├─ 存档名: ❌ 不发送                          # 纯展示字段，不影响叙事
│  ├─ 游戏版本: ❌ 不发送                        # 纯技术字段，不影响叙事
│  ├─ 创建时间: ❌ 不发送                        # 纯技术字段，不影响叙事
│  ├─ 更新时间: ❌ 不发送                        # 纯技术字段，不影响叙事
│  └─ 游戏时长秒: ❌ 不发送                      # 纯统计字段，不影响叙事
├─ 角色: ✅ 完整发送（全部子字段）
│  ├─ 身份: ✅ 发送                              # 角色基础信息，影响身份判定
│  ├─ 属性: ✅ 发送                              # 境界/气血/灵气等，影响能力判定
│  ├─ 位置: ✅ 发送                              # 当前位置，影响场景描述
│  ├─ 效果: ✅ 发送                              # buff/debuff，影响状态判定
│  ├─ 身体: ✅ 发送                              # 身体状况，影响伤势描述
│  ├─ 背包: ✅ 发送                              # 物品/灵石，影响资源判定
│  ├─ 装备: ✅ 发送                              # 装备槽位，影响战力判定
│  ├─ 功法: ✅ 发送                              # 功法进度，影响技能使用
│  ├─ 修炼: ✅ 发送                              # 修炼状态，影响修炼叙事
│  ├─ 大道: ✅ 发送                              # 大道进度，影响悟道叙事
│  └─ 技能: ✅ 发送                              # 掌握技能，影响战斗叙事
├─ 社交
│  ├─ 关系: ✅ 发送                              # NPC关系网络，影响社交互动
│  ├─ 宗门: ✅ 发送                              # 宗门系统，影响宗门相关叙事
│  ├─ 事件: ✅ 发送                              # 世界事件，影响事件承接
│  └─ 记忆
│     ├─ 短期记忆: ❌ 不发送                     # 通过inject单独发送，避免重复
│     ├─ 中期记忆: ✅ 发送                       # 重要记忆，影响叙事连贯性
│     ├─ 长期记忆: ✅ 发送                       # 或向量检索结果替代
│     └─ 隐式中期记忆: ❌ 不发送                 # 内部过渡数据，不直接影响叙事
├─ 世界: ✅ 完整发送
│  ├─ 信息: ✅ 发送                              # 世界设定，影响场景描述
│  └─ 状态: ✅ 发送                              # 世界动态，影响环境叙事
└─ 系统: ❌ 整个域不发送
   ├─ 配置: ❌ 不发送                            # 系统规则配置，不影响叙事内容
   ├─ 设置: ❌ 不发送                            # 前端UI偏好，不影响叙事内容
   ├─ 缓存: ❌ 不发送                            # 可重建的派生数据，冗余
   ├─ 行动队列: ❌ 不发送                        # 前端队列状态，不需要
   ├─ 历史: ❌ 不发送                            # 叙事历史通过短期记忆承接
   ├─ 扩展: ❌ 不发送                            # Mod/DLC数据，按需处理
   └─ 联机: ❌ 不发送                            # 联机状态通过inject单独注入
```

### 分步生成模式说明

- **第1步（正文生成）**：使用精简版存档 + 世界观提示词，只输出叙事文本
- **第2步（指令生成）**：使用精简版存档 + 完整规则提示词 + 第1步正文，输出JSON指令

### 额外注入内容（通过 inject 机制）

无论单步还是分步，以下内容通过 inject 单独发送：

| 内容 | inject角色 | depth | 说明 |
|------|-----------|-------|------|
| 短期记忆 | assistant | 2 | 最近发生的事件，用于叙事承接 |
| CoT提示词 | system | 1 | 思维链引导（如启用） |
| 联机穿越状态 | system | 3 | 穿越到他人世界时注入 |
| 离线代理提示词 | system | 2 | 扮演离线玩家时注入 |
| 防截断占位 | assistant | 0 | `</input>` 防止输入被截断 |

---

## 6) 附录：常用子结构（落盘字段）

### 6.1 物品（Item）

> `角色.背包.物品.<物品ID>` 的 value。物品是联合类型，按 `类型` 决定额外字段。

```text
Item (通用字段)
├─ 物品ID: string
├─ 名称: string
├─ 类型: string (装备|功法|丹药|材料|其他)
├─ 品质: object { quality, grade }
├─ 数量: number
├─ 描述: string
└─ ...（按类型扩展）
```

### 6.2 货币系统（CurrencyAsset）

> `角色.背包.货币.<币种ID>` 的 value。新货币系统支持多币种和动态汇率。

```text
CurrencyAsset
├─ 币种: string                                # 币种ID（与 key 一致）
├─ 名称: string                                # 展示名称
├─ 数量: number                                # 余额
├─ 价值度: number                              # 相对基准币种的价值（默认1下品灵石=1）
├─ 描述?: string
└─ 图标?: string                               # lucide 图标名

CurrencySettings
├─ 禁用币种: array (string[])                  # 用户删除过的币种ID
└─ 基准币种?: string                           # 默认：灵石_下品
```

### 6.3 掌握技能（MasteredSkill）

```text
MasteredSkill
├─ 技能名称: string
├─ 技能描述: string
├─ 来源: string
├─ 消耗?: string
├─ 熟练度: number
└─ 使用次数: number
```

### 6.4 叙事消息（GameMessage）

```text
GameMessage
├─ type: string (user|ai|system|player|gm)
├─ content: string
├─ time: string
├─ actionOptions: array (必填)                 # string[]
└─ stateChanges?: object
```

### 6.5 NPC 档案（NpcProfile）

> `社交.关系.<NPC键>` 的 value（键建议用 NPC 唯一ID；没有ID时用名字，但要确保唯一）。

```text
NpcProfile（核心字段）
├─ 名字: string
├─ 性别: string
├─ 出生日期: object { 年, 月, 日, 小时?, 分钟? }
├─ 种族?: string
├─ 出生: string|object
├─ 外貌描述: string
├─ 性格特征: array (string[])
├─ 境界: object (同 角色.属性.境界)
├─ 灵根: object
├─ 天赋: array
├─ 先天六司: object
├─ 属性: object                                    # 核心数值（整合）
│  ├─ 气血: object { 当前, 上限 }                  # HP，生命值
│  ├─ 灵气: object { 当前, 上限 }                  # MP/真元
│  ├─ 神识: object { 当前, 上限 }                  # 精神力
│  └─ 寿元上限: number                             # 最大寿命（当前年龄由出生日期自动计算）
├─ 与玩家关系: string
├─ 好感度: number
├─ 当前位置: object { 描述, x?, y? }
├─ 势力归属?: string
├─ 人格底线: array|string
├─ 记忆: array (object|string)
├─ 当前外貌状态: string
└─ 当前内心想法: string
```

#### 6.5.1 关系矩阵（RelationshipMatrixV3，可选）

> 路径：`社交.关系矩阵`（用于记录 NPC-NPC 的明确关系，可选）

```text
RelationshipMatrixV3
├─ version?: number
├─ nodes?: array (string[])
└─ edges?: array
   └─ [i]: object
      ├─ from: string
      ├─ to: string
      ├─ relation?: string
      ├─ score?: number
      ├─ tags?: array (string[])
      └─ updatedAt?: string
```

### 6.6 宗门系统（SectSystemV2）

```text
SectSystemV2
├─ 版本: number
├─ 当前宗门?: string|null
├─ 宗门档案: object (key=宗门ID/名称 -> WorldFaction)
├─ 宗门成员?: object (key=宗门ID/名称 -> string[])
├─ 宗门任务?: object (key=宗门ID/名称 -> SectTaskItem[])
├─ 宗门任务状态?: object (key=宗门ID/名称 -> SectTaskStatus)
├─ 宗门藏经阁?: object (key=宗门ID/名称 -> any[])
├─ 宗门贡献商店?: object (key=宗门ID/名称 -> any[])
├─ 宗门经营?: object (key=宗门ID/名称 -> SectManagementState)
├─ 宗门战争?: SectWarSystem
├─ 内容状态?: object (key=宗门ID/名称 -> SectContentStatus)
└─ 迁移记录?: object

SectTaskItem
├─ 任务ID: string
├─ 任务名称: string
├─ 任务描述: string
├─ 任务类型: string
├─ 难度: string
├─ 贡献奖励: number
├─ 额外奖励?: string
├─ 状态: string
├─ 期限?: string
├─ 发布人?: string
└─ 要求?: string

SectTaskStatus
├─ 已初始化: boolean
├─ 最后更新时间?: string
└─ 演变次数: number
```

#### 6.6.1 宗门经营（SectManagementState）

```text
SectManagementState
├─ 宗门名称: string
├─ 战力?: number                               # 0-100
├─ 安定?: number                               # 0-100
├─ 外门训练度?: number                         # 0-100，影响战力与战损
├─ 府库?: object
│  ├─ 灵石?: number
│  ├─ 灵材?: number
│  ├─ 丹药?: number
│  └─ 阵材?: number
├─ 设施?: object (key=设施名 -> level)         # 练功房/藏经阁/炼丹房/护山大阵等
├─ 最近结算?: string                           # ISO时间或游戏时间
└─ 月报?: array
   └─ [i]: object { 时间, 摘要, 变化? }
```

#### 6.6.2 宗门战争（SectWarSystem）

```text
SectWarSystem
├─ 当前?: SectWarState|null
└─ 历史?: array (SectWarState[])

SectWarState
├─ 战争ID: string
├─ 状态: string (备战|进行中|停战|胜利|失败)
├─ 发起方: string
├─ 守方: string
├─ 目标?: string
├─ 阶段列表: array (string[])
├─ 阶段索引: number                            # 0-based
├─ 当前阶段: string (侦察|交锋|破阵|攻山|善后)
├─ 我方: SectWarSideState
├─ 敌方: SectWarSideState
├─ 累计伤亡?: object { 我方?, 敌方? }
├─ 战报?: array (SectWarReport[])
└─ 上一次?: object                             # 上一步结算结果

SectWarSideState
├─ 宗门名称: string
├─ 战力: number                                # 0-100
├─ 外门: number
├─ 内门: number
├─ 核心: number
└─ 士气?: number                               # 0-100

SectWarReport
├─ 时间: string
├─ 阶段: string
├─ 摘要: string
├─ 我方变化?: object
└─ 敌方变化?: object
```

### 6.7 经济系统（EconomyState）

> 路径：`世界.信息.经济`（可选，用于动态汇率和地区差异）

```text
EconomyState
├─ 货币波动?: object (key=币种ID -> number)    # 全局波动系数（1=基准，0.6~1.6）
├─ 地区波动?: object (key=位置描述 -> object)
│  └─ <位置>: object
│     └─ 货币波动?: object (key=币种ID -> number)
└─ 最后更新时间?: string
```

### 6.8 炼制系统（Crafting）

> 炼器/炼丹系统的类型定义。

```text
CraftingSlot
├─ slotId: number                              # 槽位ID (1-5)
└─ item: Item|null                             # 放入的物品

CraftingRecipe
├─ materials: array (CraftingSlot[])           # 5个材料槽位
└─ craftingType: string (炼器|炼丹)

CraftingResult
├─ success: boolean
├─ resultQuality: string (废品|残次品|成品|精品|极品|神品)
├─ resultItem: Item|null
├─ processDescription: string                  # AI生成的炼制过程描述
├─ itemDescription: string                     # AI生成的成品描述
└─ successRate: number

CraftingEvent
├─ eventId: string
├─ eventType: string (炼器|炼丹)
├─ timestamp: string
├─ materials: array (string[])                 # 材料名称列表
├─ result: string                              # 结果品质
├─ itemName: string
└─ canDelete: boolean
```

---

## 7) 旧存档迁移映射（只存在于迁移器，不再运行时兼容）

> 原则：读旧档 → 迁移器产出 V3 → **只写 V3**。任何旧 key（含 `_AI说明/_AI修改规则/_AI重要提醒`）不允许再出现在落盘数据。

| 旧结构/旧 key（示例） | V3 目标路径 |
| --- | --- |
| `角色基础信息` / `玩家角色基础信息` | `角色.身份` |
| `玩家角色状态` / `状态` | `角色.属性` + `角色.位置` |
| `状态效果` / `修行状态` | `角色.效果` |
| `背包` | `角色.背包` |
| `装备` | `角色.装备` |
| `功法`（旧：塞在背包物品里或散落字段） | `角色.功法`（进度）+ `角色.背包.物品`（物品定义） |
| `修炼` | `角色.修炼` |
| `三千大道` / `大道` | `角色.大道` |
| `人物关系` / `关系` | `社交.关系` |
| `关系矩阵` / `关系网` | `社交.关系矩阵` |
| `宗门系统` / `宗门` | `社交.宗门` |
| `记忆` | `社交.记忆` |
| `世界信息` / `世界` | `世界.信息` |
| `叙事历史` / `历史.叙事` | `系统.历史.叙事` |
| `掌握技能` | `系统.缓存.掌握技能` |
| `系统配置` | `系统.配置` |
