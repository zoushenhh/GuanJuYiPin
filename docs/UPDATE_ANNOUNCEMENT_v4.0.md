# 仙途 4.0 更新日志

> **发布日期**: 2026-01-18
> **更新规模**: 148个文件变更 | +27,679/-12,151行代码

---

## 核心更新

### 1. 存档系统 V3

**主要改进**:
- 模块化结构：拆分为元数据/角色/社交/世界/系统五大领域
- 短路径设计，AI输出更稳定
- 可视化迁移工具，支持旧存档一键转换
- 原生支持联机同步

### 2. 联机穿越系统

**新增功能**:
- 世界浏览：搜索、筛选、分页
- 穿越点与签到
- 会话管理与日志
- 地图联动
- 入侵报告
- 世界可见性策略与离线代理AI

### 3. API管理面板

**核心特性**:
- 多API配置管理
- 功能分配：为主流程/思维链/指令生成/记忆/优化/世界生成/事件/宗门/向量等任务分配独立API
- 智能请求合并
- 连通性测试
- 酒馆/网页双模式

### 4. 向量记忆系统

**技术实现**:
- 基于IndexedDB的本地存储
- 关键词/标签提取 + 向量相似度混合检索
- 默认TF-IDF向量化（无需外部API）
- 可选Embedding API增强
- 降低Token压力

### 5. 世界事件系统

**替代任务系统**:
- 随时间推进的世界级事件
- 可配置触发间隔
- 自定义事件提示词
- 事件记录查询
- 重抽机制

### 6. 宗门系统 V2

**系统化重构**:
- 成员管理/藏经阁/贡献商店分区展示
- 宗门迁移工具
- `sectSystemFactory` 系统化生成

---

## 其他优化

### 地图系统
- 开局减负：先生成大陆骨架，再按需生成细节
- 新增修仙难度选项
- 局内初始化提示

### 角色系统
- 新增身体数据面板（寿元/体格/三围等）
- 六司管理器
- 优化寿元计算

### 提示词系统
- 分类管理，支持批量操作
- 权重调整（1-10）
- 联机模式只读
- 远程配置支持

### 界面优化
- 全局菜单整合
- 后端管理页（管理员）
- 新增 `design-system.css`
- 响应式优化

---

## 工程化升级

**依赖更新**:
- 新增 `@vueuse/core`、`clsx`、`class-variance-authority`、`tailwind-merge`

**工具增强**:
- 新增 `jsonExtract`、`regex`、`chatBus`、`dadBundle`、`cultivationSpeedCalculator`、`sixSiManager`

**后端架构**:
- `server/` 已移至私有仓库
- 移除公开仓库的 `docker-compose.yml`

---

## 重要变更

### 1. 存档格式升级
- 旧版存档需通过"旧存档转化"工具迁移
- 支持存档包/角色包/单个存档识别

### 2. 任务系统移除
- 移除 `QuestPanel` / `questStore` / `questGenerators`
- 用世界事件系统替代

### 3. 后端部署
- 联机/穿越功能需单独部署后端
- 本地单机游玩不受影响

---

## 升级指南

### 单机用户
1. 备份旧存档
2. 更新到 v4.0
3. 使用"旧存档转化"工具迁移
4. 开始游玩

### 联机用户
1. 部署后端服务（或联系管理员）
2. 配置后端地址
3. 注册/登录账号
4. 迁移存档到联机模式

### API配置建议

成本优化方案：
```
主流程: GPT-4o / Claude Sonnet
思维链: GPT-4o-mini / Claude Haiku
指令生成: GPT-4o-mini
记忆总结: GPT-4o-mini
世界生成: GPT-4o / Gemini Pro
向量检索: text-embedding-3-small
```

---

## 已知问题

- 部分旧存档迁移后可能出现NPC关系网络数据缺失
- 联机模式首次穿越可能需要较长加载时间
- 向量记忆系统在低端设备上可能影响性能

---

## 统计数据

| 指标 | 数值 |
|------|------|
| 提交数 | 11 |
| 文件变更 | 148 (新增36 / 删除7 / 修改105) |
| 代码量 | +27,679 / -12,151 |
| 开发周期 | 2026-01-04 → 2026-01-18 |

---

## 反馈渠道

- **QQ群**: 1079437686
- **GitHub Issues**: https://github.com/qianye60/XianTu/issues
- **官方网站**: https://www.ddct.top
