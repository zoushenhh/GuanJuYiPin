/**
 * @fileoverview 游戏循环系统类型定义（县令回合制政务决策）
 *
 * 【术语说明】
 * - 早堂升座：县令每日早晨升堂处理政务
 * - 午巡视察：中午巡视辖区
 * - 夜读批文：夜间批阅文书
 * - 季度考核：每季度一次的政绩考核
 * - 年度京察：每年一次的全面考核
 * - 回合制：每个动作消耗一定回合时间
 *
 * 【设计理念】
 * - 从"挂机修炼"改为"回合制政务决策"
 * - 玩家每做一个动作都会推进时间
 * - 定期触发考核事件，影响县令的政绩和官品
 */

import type { AIMetadata, GameTime } from './game';

// ============================================================================
// 时间系统
// ============================================================================

/**
 * 时间刻度（县令主题）
 */
export type TimeScale =
  | '时辰'      // 1个时辰 = 2小时
  | '日'        // 1天
  | '旬'        // 10天
  | '月'        // 1个月
  | '季'        // 1季度（3个月）
  | '年';       // 1年

/**
 * 时辰（古代计时单位）
 */
export type Shichen =
  | '子时' | '丑时' | '寅时' | '卯时' | '辰时' | '巳时'
  | '午时' | '未时' | '申时' | '酉时' | '戌时' | '亥时';

/**
 * 一日中的时段（县令作息）
 */
export type DayPeriod =
  | '早堂'      // 早间升堂（辰时 7-9点）
  | '午前'      // 上午处理（巳时 9-11点）
  | '午休'      // 午间休息（午时 11-13点）
  | '午后'      // 下午处理（未时 13-15点）
  | '晚堂'      // 晚间升堂（酉时 17-19点）
  | '夜间'      // 夜间处理（亥时 21-23点）
  | '深夜';     // 深夜休息（子时 23-1点）

// ============================================================================
// 回合系统
// ============================================================================

/**
 * 动作类型（县令主题）
 */
export type GovernanceActionType =
  // === 案件审理 ===
  | '审案'      // 审理案件
  | '判决'      // 作出判决
  | '调查'      // 调查取证

  // === 辖区管理 ===
  | '巡视'      // 巡视辖区
  | '征税'      // 征收税款
  | '建设'      // 监督建设
  | '赈灾'      // 赈济灾民

  // === 人事管理 ===
  | '招募'      // 招募幕僚
  | '任命'      // 任命下属
  | '赏罚'      // 奖赏惩罚

  // === 文书处理 ===
  | '批文'      // 批阅文书
  | '拟诏'      // 起草诏令
  | '归档'      // 整理档案

  // === 社交活动 ===
  | '会客'      // 会见客人
  | '宴请'      // 举办宴请
  | '拜访'      // 拜访他人

  // === 学习修养 ===
  | '读书'      // 研读经典
  | '练武'      // 练习武艺
  | '方略'      // 研习方略

  // === 休闲活动 ===
  | '游历'      // 游历四方
  | '赏景'      // 观赏风景
  | '品茶'      // 品茶论道
  | '休息'      // 休息养生

  // === 其他 ===
  | '等待'      // 等待（跳过本回合）
  | '其他';     // 其他动作

/**
 * 回合数据结构
 */
export interface Turn extends AIMetadata {
  回合数: number;               // 当前回合数
  回合开始时间: GameTime;      // 回合开始时的游戏时间
  回合结束时间: GameTime;      // 回合结束时的游戏时间

  // 当前动作
  当前动作?: {
    类型: GovernanceActionType;
    描述: string;
    目标?: string;             // 动作目标（NPC名、地点等）
  };

  // 动作队列（一个回合可以有多个动作）
  动作队列: TurnAction[];

  // 回合结果
  回合结果?: {
    文本: string;              // 回合结果描述
    数据变更?: string[];      // 数据变更指令
    事件?: string[];          // 触发的事件
  };
}

/**
 * 动作队列项
 */
export interface TurnAction {
  id: string;                    // 动作ID
  类型: GovernanceActionType;    // 动作类型
  描述: string;                  // 动作描述
  目标?: string;                // 动作目标

  // 消耗
  时间消耗: number;             // 消耗的回合数（通常为1）
  精力消耗?: number;            // 消耗的精力（健康/民心/智慧）
  银两消耗?: number;            // 消耗的银两
  粮食消耗?: number;            // 消耗的粮食

  // 要求
  要求?: {
    最低官品?: string;          // 需要的最低官品
    最低精力?: number;          // 最低精力要求
    特殊条件?: string;          // 特殊条件
  };

  // 效果
  预期效果?: string;            // 预期效果描述
}

// ============================================================================
// 考核系统
// ============================================================================

/**
 * 考核类型
 */
export type AssessmentType =
  | '季考'      // 季度考核
  | '年考'      // 年度考核（京察）
  | '特考'      // 特殊考核
  | '自评';     // 自我评估

/**
 * 考核等级
 */
export type AssessmentGrade =
  | '卓越'      // 表现优异，可能晋升
  | '优良'      // 表现良好
  | '称职'      // 表现合格
  | '不称职'    // 表现不佳
  | '失职';     // 表现很差，可能罢免

/**
 * 考核项目
 */
export interface AssessmentItem {
  项目: string;                  // 考核项目名称
  权重: number;                 // 权重 [0-1]
  评分: number;                 // 评分 [0-100]
  评语: string;                  // 考核评语
}

/**
 * 考核结果
 */
export interface AssessmentResult {
  考核类型: AssessmentType;     // 考核类型
  考核时间: GameTime;           // 考核时间
  考核周期: string;             // 考核周期（如："开元1050年春季"）

  // 考核项目
  项目评分: AssessmentItem[];   // 各项评分

  // 综合结果
  综合得分: number;             // 综合得分 [0-100]
  等级: AssessmentGrade;       // 考核等级
  总体评价: string;             // 总体评价

  // 奖惩
  奖赏?: {
    政绩奖励?: number;          // 政绩奖励
    银两奖励?: number;          // 银两奖励
    物品奖励?: string[];        // 物品奖励
    特殊奖励?: string;         // 特殊奖励
  };

  惩罚?: {
    政绩扣除?: number;          // 政绩扣除
    罚银?: number;              // 罚款
    降职?: boolean;             // 是否降职
    其他惩罚?: string;         // 其他惩罚
  };

  // 影响
  影响?: {
    民心变化?: number;          // 民心变化
    威望变化?: number;          // 威望变化
    晋升机会?: boolean;         // 是否有晋升机会
  };
}

// ============================================================================
// 游戏循环状态
// ============================================================================

/**
 * 游戏循环状态
 */
export interface GameLoopState extends AIMetadata {
  // 当前时间
  当前时间: GameTime;           // 当前游戏时间

  // 当前时段
  当前时段: DayPeriod;          // 当前时段

  // 回合信息
  当前回合: Turn;               // 当前回合数据

  // 考核信息
  上次季考: GameTime | null;    // 上次季考时间
  上次年考: GameTime | null;    // 上次年考时间

  // 待处理事件
  待处理事件: string[];         // 待处理的事件ID列表

  // 循环配置
  配置: {
    自动存档间隔: number;      // 自动存档间隔（回合数）
    自动存档倒数: number;      // 距离下次自动存档的回合数
  };
}

// ============================================================================
// 游戏循环管理
// ============================================================================

/**
 * 游戏循环事件
 */
export interface GameLoopEvent {
  id: string;                    // 事件ID
  类型: '时间流逝' | '时段变化' | '考核触发' | '随机事件' | '其他';
  时间: GameTime;               // 事件时间
  描述: string;                  // 事件描述
  数据: {
    [key: string]: any;
  };
}

/**
 * 时间推进结果
 */
export interface TimeAdvanceResult {
  推进前: GameTime;             // 推进前的时间
  推进后: GameTime;             // 推进后的时间
  变化: {
    新增事件?: string[];        // 新增的事件
    触发考核?: AssessmentResult; // 触发的考核
    状态变化?: string[];        // 其他状态变化
  };
  回合数: number;               // 经过回合数
}

// ============================================================================
// 导出类型集合
// ============================================================================

export type {
  // 核心类型
  Turn,
  TurnAction,
  AssessmentResult,
  AssessmentItem,
  GameLoopState,
  GameLoopEvent,
  TimeAdvanceResult,

  // 类型枚举
  TimeScale,
  Shichen,
  DayPeriod,
  GovernanceActionType,
  AssessmentType,
  AssessmentGrade,
};
