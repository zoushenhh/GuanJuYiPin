import { DICE_ROLLING_RULES } from '../definitions/textFormats';

/**
 * @fileoverview CoT 核心提示词 v5.2.0
 * @version 5.2.0
 * @lastUpdated 2025-01-17
 *
 * 【更新日志】
 * - v5.2.0: 增强变量更新全面性
 *   - 新增NPC属性变化指令（健康/威望/智慧/城市等级/位置）
 *   - 新增战斗与消耗的NPC更新提醒
 *   - 新增变量更新全面性检查清单
 * - v5.1.0: 适配 v4.0 新功能
 *   - 使用 V3 存档短路径（元数据/角色/社交/世界/系统）
 *   - 新增世界事件系统同步
 *   - 新增组织系统相关指令
 * - v5.0.0: 针对城市建设游戏优化（考核/城市等级/发展）
 * - v4.0.0: 全面重构思维链，增强AI感知游戏状态能力
 */

// 导出静态的CoT核心提示词模板，用于提示词管理页面
export const COT_CORE_PROMPT_TEMPLATE = `
# 低噪声协议（无思维链）

用户意图："{{用户输入}}"

 ## 禁止
 - 绝对禁止输出：\`<thinking>\` / 思维链 / 任何推理过程标签

## 占位符规则（CRITICAL）
- 本提示词中出现的 [NPC名] / [方略名] / [策略ID] 只是占位符说明
- 输出 tavern_commands.key 时必须替换为真实名称，且不要保留方括号 []
- 方括号 [] 只有"数组索引"能用：例如 角色.效果[0]

 ## 内部自检清单（不要写出来）

### 基础同步（V3短路径）- 必须全面更新！
□ 位置变化 → set \`角色.位置\`
□ 时间流逝 → add \`元数据.时间.分钟\`（发展/深入调研按实际时长）
□ 货币变化 → add \`角色.背包.货币.<币种ID>.数量\`（币种ID如:铜钱/银两/金锭）
□ 物品增删 → set/delete \`角色.背包.物品.[物品ID]\`

### 发展与晋升
□ 日常发展 → add \`角色.属性.城市等级.当前进度\`
□ 策略熟练 → add \`角色.策略.策略进度.[策略ID].熟练度\`
□ 领悟治国之道进展 → add \`角色.大道.方略列表.[方略名].当前经验\`
□ 治理方略解锁 → set \`角色.大道.方略列表.[方略名]\`（完整DaoData对象）
□ 策略解锁技能 → push \`角色.策略.策略进度.[策略ID].已解锁技能\`
□ 小阶段晋升 → set \`角色.属性.城市等级.阶段\`（初期→中期→后期→成熟→极境）
□ 大城市等级晋升 → set \`角色.属性.城市等级.名称\` + 更新属性上限

### 考核晋升系统（重要！）
□ 考核开始 → push \`角色.效果\` 添加"考核中"状态
□ 每项考核 → add \`角色.属性.健康.当前\`（负）+ add \`角色.属性.威望.当前\`（负）
□ 考核成功 → set 新官品 + 更新属性上限 + push \`社交.事件.事件记录\`
□ 考核失败 → 降职/罢官处理 + push \`社交.事件.事件记录\`
⚠️ 考核必须多回合！每项考核=1+对话轮次，禁止一回合完成！

### 战斗与消耗 - 必须更新所有参与者！
□ 施法/出招 → add \`角色.属性.威望.当前\`（负，按技能消耗%）
□ 受伤 → add \`角色.属性.健康.当前\`（负）
  ⚠️ 玩家受伤 → add \`角色.属性.健康.当前\`
  ⚠️ NPC受伤 → add \`社交.关系.[NPC名].属性.健康.当前\`
□ 智慧消耗 → add \`角色.属性.智慧.当前\`（负）
  ⚠️ NPC智慧消耗 → add \`社交.关系.[NPC名].属性.智慧.当前\`
□ 非常规手段代价 → add \`角色.属性.寿命.当前\`（负）
□ 状态效果 → push \`角色.效果\`（中毒/重伤/虚弱等）
  ⚠️ NPC中毒/重伤等 → set \`社交.关系.[NPC名].当前外貌状态\`

### NPC交互 - 必须全面更新NPC状态！
□ NPC出场 → set \`社交.关系.[NPC名]\`（完整对象）
□ 好感变化 → add \`社交.关系.[NPC名].好感度\`
□ NPC记忆 → push \`社交.关系.[NPC名].记忆\`
□ NPC状态 → set \`社交.关系.[NPC名].当前外貌状态\`
□ NPC属性变化（重要！）：
  - NPC健康变化 → add \`社交.关系.[NPC名].属性.健康.当前\`
  - NPC威望变化 → add \`社交.关系.[NPC名].属性.威望.当前\`
  - NPC智慧变化 → add \`社交.关系.[NPC名].属性.智慧.当前\`
  - NPC官品变化/晋升 → set \`社交.关系.[NPC名].官品\` {"名称":"...","阶段":"..."}（必要时 add 寿命上限）
  - NPC寿命上限变化(相关手段) -> add/set \`社交.关系.[NPC名].属性.寿命上限\`
  - NPC内心想法/施政状态变化 -> set \`社交.关系.[NPC名].当前内心想法\`
  - NPC位置变化 → set \`社交.关系.[NPC名].当前位置\`
□ 实时关注NPC → 若\`实时关注\`为true，即使不在身边也要更新其位置/状态/内心想法

### 世界事件系统
□ 重大事件发生 → push \`社交.事件.事件记录\`
  格式：{事件ID,事件名称,事件类型,事件描述,影响等级,影响范围,相关人物,发生时间}
□ 事件类型：天灾/人祸/人物风波/势力变动/重要机遇/宝物出世

### 组织系统
□ 组织贡献 → add \`社交.组织.成员信息.贡献\`
□ 组织任务更新（专用生成/任务系统） → set \`社交.组织.组织任务.<组织名>\`（必要时同步 \`社交.组织.组织任务状态.<组织名>\`）

### 特殊事件
□ 机遇获得 → set \`角色.背包.物品.[物品ID]\`
□ 声望变化 → add \`角色.属性.声望\`

### ⚠️ 重要提醒：变量更新全面性检查
每次生成前必须检查：
1. 是否有战斗？→ 所有参与者的健康/威望/智慧都要更新！
2. 是否有NPC互动？→ NPC的好感度/记忆/状态都要更新！
3. 是否有时间流逝？→ 时间必须更新！
4. 是否有施政/晋升？→ 官品进度/阶段必须更新！
5. 是否有物品交易？→ 货币/物品必须更新！
6. 是否有NPC受伤/消耗？→ NPC的属性必须更新！

## 行动选项
- 若启用：输出 \`action_options\`（3-5个）
- 若未启用：不要输出 \`action_options\`

${DICE_ROLLING_RULES}
`.trim();

/**
 * 动态生成CoT提示词（用于运行时）
 */
export function getCotCorePrompt(userInput: string, enableActionOptions: boolean = false): string {
  const intentMatch = userInput.match(/<行动趋向>([\s\S]*?)<\/行动趋向>/);
  const actualIntent = intentMatch ? intentMatch[1].trim() : (userInput || '无');

  return COT_CORE_PROMPT_TEMPLATE.replace('{{用户输入}}', actualIntent);
}

// 保留旧的导出以兼容现有代码
export const cotCorePrompt = getCotCorePrompt('');
